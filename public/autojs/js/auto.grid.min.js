var auto=auto||{};auto.grid=function(t){var e=this;if(riot.observable(this),!t)throw"settings is undefined";if(!window.jQuery)throw"jquery is not loaded";if(!t.target)throw"settings.target is undefined";if(!$(t.target).is("div"))throw"settings.target must be a div element";if(this.stateplayer=new auto.grid.stateplayer,this.settings=$.extend(t||{},{pageSize:20}),this.settings.target=$(t.target),this.settings.target.addClass("autogrid").hide(),this.table=$("<table>"),this.settings.target.append(this.table),this.settings.actions)for(var n=0;n<this.settings.actions.length;n++)this.settings.actions[n].init&&this.settings.actions[n].init(this);this.settings.pager&&("infinite"===this.settings.pager?this.pager=new auto.grid.pagers.infinite(e):"basic"==this.settings.pager?this.pager=new auto.grid.pagers.basic(e):"object"==typeof this.settings.pager&&(this.pager=this.settings.pager)),this.settings.state&&this.setState(this.settings.state)},auto.grid.prototype.normalizeState=function(t){return t instanceof auto.grid.state?t:new auto.grid.state(t)},auto.grid.prototype.setState=function(t,e){t=this.normalizeState(t),this.stateplayer.push(t),this.trigger("prerender",t),this.render(t,e),this.trigger("postrender",t),this.settings.target.show()},auto.grid.prototype.getState=function(){return this.stateplayer.get()},auto.grid.prototype.notify=function(t){var e=$.extend(this.getState(),t||{});e.data.items=null,this.trigger("change",e)},auto.grid.prototype.getTarget=function(){return this.settings.target},auto.grid.prototype.getRows=function(){return this.table.find("tr.arow")},auto.grid.prototype.addRow=function(t){var e=$("<tr>");return t&&e.addClass(t),this.table.append(e),e},auto.grid.prototype.addRowAtIndex=function(t){var e=$("<tr>");return this.table.find("tr.arow").eq(t).before(e),e},auto.grid.prototype.addRowAfter=function(t){return this.addRowAtIndex(t.rowIndex)},auto.grid.prototype.render=function(t){var e=this;if(1==t.page&&(this.table.empty(),this.renderColumns(t)),t.data.exists()){var n=t.columns.getVisible(),i=function(t,n){if(e.settings.actions){var i=$.grep(e.settings.actions,function(t){return n(t)});$(i).each(function(e,n){var i=$("<td>");n.name&&i.text(n.name),n.tooltip&&i.prop("title",n.tooltip),i.addClass("action"),t.row.append(i),n.cell&&n.cell.render&&n.cell.render($.extend({cell:i},t))})}},s=function(t){$(t.rowData.items).each(function(i,s){var r=n[i],a=$("<td>");if(t.row.append(a),e.settings.render&&e.settings.render.cells){var o=$.extend({cell:a,column:r,cellData:s},t),c=e.settings.render.cells(o);c&&a.html(c)}else a.html(s)})};$(t.data.getVisible()).each(function(n,r){var a=e.addRow("arow"),o={row:a,rowIndex:n,rowData:{items:r,object:t.data.toObject(n)}};i(o,function(t){return"left"==t.orient||!t.orient}),s(o,r),i(o,function(t){return"right"==t.orient})})}},auto.grid.prototype.renderColumns=function(t){var e=this,n=t.columns.getVisible();if(!t.columns.exists()||!n)return!1;var i=this.addRow("header"),s=function(t){if(e.settings.actions){var n=$.grep(e.settings.actions,function(e){return t(e)});$(n).each(function(t,e){var n=$("<td>");e.name&&n.text(e.name),i.append(n),n.addClass("action"),e.header&&e.header.render&&e.header.render({row:i,cell:n})})}};s(function(t){return"left"==t.orient||!t.orient}),$(n).each(function(n,s){var r=$("<td>");if(r.text(s.description||s.name),r.on("selectstart",function(){return!1}),s.sort){r.addClass("autosort");var a=$("<i class='fa'>");a.data("name",s.name||s.description),r.append(a),a.toggleClass(s.sortOrder?"on fa-chevron-"+("asc"==s.sortOrder?"up":"down"):"fa-chevron-down"),r.on("click",function(n){a.hasClass("on")?(a.toggleClass("fa-chevron-down"),a.toggleClass("fa-chevron-up")):a.addClass("on"),e.settings.multiSort&&n.shiftKey||i.find("td i").each(function(){$(this).removeClass("on")}),a.removeClass("on").addClass("on"),$(t.columns.getSorted()).each(function(t,e){delete e.sortOrder}),i.find("td i.on").each(function(e,n){var i=$(n),s=t.columns.getByName(i.data("name"));s.sortOrder=i.hasClass("fa-chevron-up")?"asc":"desc"}),e.trigger("sort",t.columns.items)})}i.append(r)}),s(function(t){return"right"==t.orient})},auto.grid.state=function(t){var e=this;if(e.page=1,e.data={items:[],length:function(){return e.data.items.length},exists:function(){return e.data.items.length>0},get:function(t){if(0===e.columns.getHidden().length)return e.data.items;t=t||function(){return!0};for(var n=[],i=0;i<e.data.items.length;i++){for(var s=e.data.items[i].slice(),r=e.columns.items.length-1;r>=0;r--)t(e.columns.items[r],s[r],r)||s.splice(r,1);n.push(s)}return n},getVisible:function(){return e.data.get(function(t){return void 0===t.visible||t.visible===!0})},getHidden:function(){return e.data.get(function(t){return t.visible===!1})},toObject:function(t){if(!e.data.exists())return null;for(var n={},i=0;i<e.columns.items.length;i++){var s=e.columns.items[i];n[s.name]=e.data.items[t][i]}return n},toObjects:function(){var t=[];if(!e.data.exists())return null;for(var n=e.data.items,i=0;i<n.length;i++)t.push(e.data.toObject(i));return t}},e.columns={items:[],length:function(){return e.columns.items.length},exists:function(){return e.columns.items.length>0},getVisible:function(){return e.columns.exists()?$.grep(e.columns.items,function(t){return void 0===t.visible||t.visible===!0}):[]},getHidden:function(){return e.columns.exists()?$.grep(e.columns.items,function(t){return t.visible===!1}):[]},getIndex:function(t){for(var n=e.columns.items,i=0;i<n.length;i++)if(n[i].name==t)return i;return-1},getByName:function(t){for(var n=e.columns.items,i=0;i<n.length;i++)if(n[i].name==t)return n[i];return null},getSorted:function(){return $.grep(e.columns.items,function(t){return t.sortOrder})}},e.sort={items:[],length:function(){return e.sort.items.length},exists:function(){return e.sort.items.length>0}},t&&t.columns){for(var n=[],i=0;i<t.columns.length;i++){var s=t.columns[i];n.push("string"==typeof s?{name:s}:s)}t.columns=n}return t&&(e.sort.items=t.sort,e.data.items=t.data,e.columns.items=t.columns,e.page=t.page||e.page,e.total=t.total),e},auto.grid.stateplayer=function(){this.states=[],this.push=function(t){this.states.push(t)},this.pop=function(){return this.states.pop()},this.unshift=function(){return this.states.unshift()},this.shift=function(t){return this.states.shift(t)},this.merge=function(){},this.get=function(){return this.states[this.states.length-1]},this.clear=function(){this.states=[]}},auto.grid.pagers=auto.grid.pagers||{},auto.grid.pagers.basic=function(t,e){this.settings=$.extend({},e);riot.observable(this);var n=$("<div class='pager'>"),i=$("<ul class='pager-basic'>");n.append(i),t.settings.target.after(n),t.on("prerender",function(e){t.table.empty(),t.renderColumns(e),i.empty();var s=e.page,r=Math.ceil(e.total/t.settings.pageSize),a=$("<li class='link prev' title='Previous'><span class='fa fa-chevron-left'/></li>"),o=$("<li class='link next' title='Next'><span class='fa fa-chevron-right'/></li>");s==r?o.addClass("disabled"):o.on("click",function(){t.notify({page:s+1})}),1==s?a.addClass("disabled"):a.on("click",function(){t.notify({page:s-1})}),i.append(a),i.append("<li class='page'>"+s+" / "+r+"</li>"),i.append(o),n.fadeIn()})},auto.grid.pagers.infinite=function(t,e){e=$.extend({},e);var n=$(window),i=($(document),t.getTarget()),s=e.offset||300,r=!1;riot.observable(this),this.settings=e;var a=function(){var e=t.getState();t.notify({page:e.page+1})},o=function(){r&&n.scrollTop()>i.offset().top+i.outerHeight()-n.height()-s&&(r=!1,a())};n.scroll(function(){o()}),o(),t.on("prerender",function(){r=!0}),t.on("postrender",function(){n.trigger("scroll")})},auto.grid.actions=auto.grid.actions||{},auto.grid.actions.count=function(){riot.observable(this),this.init=function(t){this.grid=t},this.cell={render:function(t){t.cell.css("text-align","right"),t.cell.css("color","#ccc"),t.cell.html(t.row.index())}}},auto.grid.actions.select=function(t){var e=this;return riot.observable(this),this.orient=t.orient||"left",this.tooltip=t.tooltip||"",this.init=function(t){this.grid=t},this.header={render:function(t){var n=$("<input type='checkbox' />");t.cell.append(n),e.on("one",function(){n.prop("checked",e.grid.getRows().length===e.getSelectedRows().length)}),n.on("click",function(){var t=n.is(":checked");e.trigger("inner-all",t).trigger("all",t)})}},this.cell={render:function(n){var i=$("<input type='checkbox' />");n.cell.append(i);var s=function(){t.highlight&&(n.row.removeClass("highlight"),i.is(":checked")&&n.row.addClass("highlight"))};e.on("inner-all",function(t){i.prop("checked",t),s()}),i.on("click",function(){s(),e.trigger("one",i.is("checked"))})}},this.getSelectedRows=function(){return this.grid.table.find("tr.arow input[type='checkbox']:checked")},this},auto.grid.actions.expand=function(t){var e=this;riot.observable(this),this.orient=t.orient||"left",this.tooltip=t.tooltip||"",this.hide=t.hide||!1,this.expandClass=t.expandClass||"fa fa-chevron-right blue",this.collapseClass=t.collapseClass||"fa-chevron-down",this.init=function(t){this.grid=t},this.cell={render:function(t){t.row.on("destroyed",function(){t.container&&t.container.parent().remove()});var n=$("<i>");n.addClass(e.expandClass),t.cell.append(n),t.cell.on("click",function(){n.toggleClass(e.collapseClass);var i=n.hasClass(e.collapseClass);if(i){var s;e.hide&&t.container?(s=t.container,s.closest("tr").show()):(s=$("<td colspan='99' />"),n.closest("tr").after($("<tr class-'expand'>").append(s))),t.container=s,e.trigger("expand",t)}else{var r=n.closest("tr").next();e.hide?r.hide():(t.container=null,r.remove()),e.trigger("collapse",t)}})}}};